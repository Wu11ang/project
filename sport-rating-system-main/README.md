# ORTUS JUDO - Система рейтинга единоборств

Полнофункциональная система управления рейтингами, тренировками и турнирами для клуба единоборств с системой ролей и подтверждений.

## Возможности

### Система ролей
- **Админ** - полный контроль над системой
- **Тренер** - управление спортсменами, расписанием, соревнованиями, турнирами
- **Спортсмен** - регистрация на соревнования, запись на тренировки, просмотр рейтинга

### Основной функционал

**Аутентификация:**
- Регистрация по номеру телефона с выбором роли
- JWT аутентификация
- Выбор вида единоборства (Дзюдо, BJJ, ММА)
- Система подтверждения спортсменов тренером
- Автоматическое определение весовой категории по весу

**Соревнования и турниры:**
- Пошаговый wizard создания соревнования (6 шагов)
- Весовые категории с автоопределением
- Регистрация/отмена регистрации спортсменов
- Автоматическая генерация турнирной сетки (bracket)
- Запись результатов прямо из турнирной сетки
- Автоматическое продвижение победителей
- Обработка одиночных участников (автопобеда)

**Турнирная сетка:**
- Алгоритм Fisher-Yates для случайного распределения
- Обработка нечётного числа участников (bye - автопроход)
- Визуальная страница с категориями М/Ж
- Линии-коннекторы между раундами
- Свёрнутые BYE-матчи
- Запись результатов из сетки (для тренера/админа)

**Расписание и тренировки:**
- Создание недельного расписания тренером
- Бронирование тренировок спортсменом
- Первая тренировка бесплатная (trial)
- Система подписок (месячная, квартальная, годовая, по занятиям)
- Автоматическая проверка подписки при бронировании
- Лимит участников на тренировку

**Рейтинговая система:**
- Рейтинг по сезонам с переключателем
- W/L ratio (победы/поражения)
- Золотые медали (чемпион категории)
- Рейтинг филиалов (общие очки, средние, кол-во спортсменов)
- Пагинация ("Показать ещё")
- Фильтр "Только мои спортсмены" для тренера
- Автоуведомление о повышении пояса (без дубликатов)

**Система поясов:**
- 7 уровней поясов (белый - чёрный)
- Пороговые значения очков для каждого пояса
- Повышение пояса только тренером
- Индикаторы готовности к повышению

**Публичный экран:**
- Таблица лидеров для большого экрана в зале
- Автосмена категорий каждые 12 секунд
- Фильтрация по филиалу
- Клавиатурное управление

---

## Требования

- Node.js (версия 14 или выше)
- npm

## Установка и запуск

### 1. Установите зависимости
```bash
npm install
```

### 2. Инициализируйте базу данных
```bash
npm run init-db
```

Дефолтный админ:
- Телефон: `+77771234567`
- Пароль: `admin123`

### 3. Запустите сервер
```bash
npm start
```

Для разработки с автоперезагрузкой:
```bash
npm run dev
```

### 4. Откройте браузер
```
http://localhost:3000/login.html
```

---

## Использование по ролям

### Администратор

1. Войти: `+77771234567` / `admin123`
2. Создать филиалы: "Филиалы" -> "+ Добавить"
3. Создать сезон: "Сезоны" -> "+ Добавить" (отметить "Активный")

### Тренер

**Регистрация:**
1. `/login.html` -> "Зарегистрироваться"
2. Роль: Тренер, заполнить данные, выбрать филиал
3. Сразу можно входить

**Панель:** `/coach-dashboard.html`

**Возможности:**
- **Мои спортсмены** - просмотр, редактирование, повышение пояса
- **Заявки** - подтверждение/отклонение новых спортсменов
- **Соревнования** - wizard: создание -> категории -> регистрация -> сетка -> матчи -> итоги
- **Расписание** - недельное расписание, записи, подписки
- **Филиал** - все спортсмены филиала
- **Рейтинг** - общий рейтинг с фильтром "Только мои" и выбором сезона

### Спортсмен

**Регистрация:**
1. `/login.html` -> "Зарегистрироваться"
2. Роль: Спортсмен, заполнить все данные
3. Выбрать филиал и тренера
4. Ожидать подтверждения тренера

**Панель:** `/athlete-dashboard.html`

**Возможности:**
- Профиль с характеристиками
- Регистрация на соревнования
- Расписание тренера, запись на тренировки
- Рейтинг и история боёв

---

## Турнирная сетка

**Страница:** `/bracket.html?competition={id}`

### Генерация (тренер)
1. Открыть соревнование -> Шаг "Сетка"
2. Нажать "Генерировать сетку"
3. Система автоматически:
   - Перемешивает спортсменов (Fisher-Yates)
   - Рассчитывает размер сетки (ближайшая степень 2)
   - Создаёт дерево матчей
   - При нечётном числе - автопроход (bye)
   - При 1 спортсмене - автопобеда

### Визуализация
- Табы категорий (группировка М/Ж)
- Раунды: Раунд 1 -> 1/4 -> Полуфинал -> Финал
- Линии-коннекторы между раундами
- Свёрнутые BYE-матчи
- Кнопка "Записать результат" для авторизованных пользователей

---

## Публичный экран для зала

**URL:**
```
http://localhost:3000/leaderboard.html
```

**Для конкретного филиала:**
```
http://localhost:3000/leaderboard.html?branch=1
```

**Отключить автосмену:**
```
http://localhost:3000/leaderboard.html?auto=false
```

**Управление:**
- `<-` `->` - переключение категорий
- `Пробел` - стоп/старт автосмены
- `F` - полноэкранный режим
- `R` - обновить данные

**Подключение к экрану в зале:**
- Прямое HDMI подключение компьютера
- Raspberry Pi / Mini PC с Chromium в kiosk-режиме
- Smart TV со встроенным браузером

---

## Весовые категории

### Мужчины (юниоры)
50, 55, 60, 66, 73, 81, 90, 100, +100 кг

### Женщины (юниоры)
40, 44, 48, 52, 57, 63, 70, 78, +78 кг

## Начисление очков

| Уровень         | Иппон | По баллам |
|-----------------|-------|-----------|
| Клубное         | 50    | 30        |
| Городское       | 100   | 60        |
| Региональное    | 150   | 90        |
| Национальное    | 250   | 150       |
| Международное   | 400   | 250       |

## Система поясов

| Пояс        | Мин. очков |
|-------------|-----------|
| Белый       | 0         |
| Жёлтый      | 100       |
| Оранжевый   | 300       |
| Зелёный     | 600       |
| Синий       | 1000      |
| Коричневый  | 1500      |
| Чёрный      | 2500      |

Повышение пояса по решению тренера. Система автоматически уведомляет о готовности.

---

## API Endpoints

### Аутентификация
```
POST /api/auth/register        - Регистрация
POST /api/auth/login           - Вход
GET  /api/auth/me              - Текущий пользователь
```

### Тренер
```
GET  /api/coaches/pending-athletes     - Заявки на подтверждение
POST /api/coaches/approve-athlete/:id  - Одобрить/отклонить
GET  /api/coaches/my-athletes          - Мои спортсмены
PUT  /api/coaches/update-athlete/:id   - Изменить характеристики
GET  /api/coaches/belt-eligible        - Готовые к повышению пояса
POST /api/coaches/promote-belt/:id     - Повысить пояс
```

### Соревнования
```
GET    /api/competitions                      - Все соревнования
POST   /api/competitions                      - Создать
GET    /api/competitions/:id                  - Детали
POST   /api/competitions/:id/register         - Зарегистрироваться
GET    /api/competitions/:id/registrations    - Участники
DELETE /api/competitions/:id/registrations/:athleteId - Отменить регистрацию
```

### Турнирная сетка
```
POST /api/competitions/:id/generate-bracket          - Генерация сетки
GET  /api/competitions/:id/bracket                   - Получить сетку
POST /api/competitions/:id/bracket/:matchId/result   - Результат матча
```

### Спарринги и бои
```
POST /api/sparrings                    - Создать спарринг
GET  /api/competitions/:id/sparrings   - Все спарринги
POST /api/fights                       - Добавить результат боя
GET  /api/athletes/my-sparrings        - История боёв спортсмена
```

### Расписание
```
GET    /api/schedules/my                    - Расписание тренера
POST   /api/schedules                       - Создать занятие
PUT    /api/schedules/:id                   - Обновить
DELETE /api/schedules/:id                   - Деактивировать
GET    /api/coaches/:coachId/schedule       - Публичное расписание
GET    /api/coaches/:coachId/profile        - Профиль тренера
```

### Бронирование
```
GET    /api/bookings/my           - Мои записи (спортсмен)
POST   /api/bookings              - Записаться на тренировку
DELETE /api/bookings/:id          - Отменить запись
GET    /api/coaches/bookings      - Записи на мои тренировки (тренер)
PUT    /api/coaches/bookings/:id  - Обновить статус записи
```

### Подписки
```
GET  /api/subscriptions/my        - Мои подписки (спортсмен)
POST /api/subscriptions           - Создать подписку (тренер)
PUT  /api/subscriptions/:id       - Обновить подписку
GET  /api/coaches/subscriptions   - Все подписки (тренер)
```

### Рейтинги
```
GET /api/ratings                  - Общий рейтинг (?season_id=N, ?limit=N, ?offset=N)
GET /api/ratings/branch/:id       - Рейтинг филиала
GET /api/ratings/branch-rankings  - Рейтинг филиалов (?season_id=N)
GET /api/ratings/athlete/:id      - История спортсмена
```

### Справочники
```
GET /api/disciplines              - Виды единоборств
GET /api/belt-levels              - Уровни поясов
GET /api/branches/:id/athletes    - Спортсмены филиала
GET /api/seasons                  - Все сезоны
GET /api/seasons/active           - Активный сезон
```

---

## Структура проекта

```
sport-rating-system-main/
├── server.js                    # Express сервер с JWT
├── package.json
├── judo_rating.db               # SQLite БД (создаётся автоматически)
├── scripts/
│   ├── initDb.js                # Инициализация БД
│   ├── migrate-v2.js            # Миграция v2
│   └── fullTest.js              # QA тест (3 филиала, 60 спортсменов, 4 турнира)
└── public/
    ├── login.html               # Вход / регистрация
    ├── auth.js                  # Логика аутентификации
    ├── auth.css                 # Стили авторизации
    ├── index.html               # Админ-панель
    ├── app.js                   # Логика главной страницы
    ├── app-auth.js              # Логика админ-панели
    ├── coach-dashboard.html     # Панель тренера
    ├── coach-dashboard.js       # Логика панели тренера
    ├── athlete-dashboard.html   # Панель спортсмена
    ├── athlete-dashboard.js     # Логика панели спортсмена
    ├── bracket.html             # Турнирная сетка
    ├── bracket.js               # Логика турнирной сетки
    ├── bracket.css              # Стили турнирной сетки
    ├── leaderboard.html         # Публичный экран
    ├── leaderboard.js           # Логика публичного экрана
    ├── leaderboard.css          # Стили публичного экрана
    ├── variables.css            # CSS переменные
    └── styles.css               # Общие стили
```

## База данных

| Таблица | Описание |
|---------|----------|
| users | Все пользователи (админ, тренер, спортсмен) |
| coaches | Профили тренеров (филиал, специализация) |
| athletes | Профили спортсменов (вес, пояс, martial_art) |
| branches | Филиалы клуба |
| seasons | Сезоны |
| competitions | Соревнования |
| competition_categories | Весовые категории соревнований |
| competition_registrations | Регистрации на соревнования |
| sparrings | Пары для боёв |
| fights | Результаты боёв |
| ratings | Рейтинги по сезонам |
| tournament_brackets | Турнирная сетка (матчи) |
| notifications | Уведомления (повышение пояса и др.) |
| disciplines | Виды единоборств |
| training_schedules | Расписание тренировок |
| training_bookings | Бронирования тренировок |
| subscriptions | Подписки спортсменов |
| belt_levels | Уровни поясов |
| weight_categories_mapping | Справочник весовых категорий |
| athlete_changes_log | Логи изменений характеристик |

---

## Типичный workflow

```
1. Админ создаёт филиалы и сезон
          |
2. Тренеры регистрируются
          |
3. Спортсмены регистрируются -> Ожидают подтверждения
          |
4. Тренер одобряет спортсменов
          |
5. Тренер создаёт соревнование (wizard)
          |
6. Регистрация спортсменов на соревнование
          |
7. Генерация турнирной сетки
          |
8. Запись результатов матчей (из сетки или панели)
          |
9. Рейтинг автоматически обновляется
          |
10. Уведомления о повышении пояса
```

## Troubleshooting

**Не могу войти**
- Убедитесь, что сервер запущен: `npm start`

**Спортсмен не может войти**
- Тренер должен одобрить заявку в разделе "Заявки"

**Турнирная сетка не генерируется**
- Убедитесь, что в категории зарегистрирован хотя бы 1 спортсмен

**Публичный экран пустой**
- Проверьте, что есть рейтинг в текущем активном сезоне

**Порт 3000 занят**
- Измените PORT в server.js или завершите процесс на порте

---

Создано для клуба Ortus Judo (Астана)
